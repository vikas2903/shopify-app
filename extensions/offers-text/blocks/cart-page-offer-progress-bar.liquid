<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<style>
    :root{
        --drawerColor:#64112f
    }
    .progress-wrapper {
      margin-bottom: 2rem;
  }
    .progress-container-bg-color {
        background-image: linear-gradient(-65deg, #fff, #fff);
        height: 80px;
        padding: 3px 0;
    }
    .progress-container-wrap {
        margin-top: 10px;
        text-align: center;
        margin-bottom: 60px;
    }
    .progress-container-wrap .progress-container {
        display: flex;
        justify-content: space-between;
        position: relative;
        margin-bottom: 30px;
        max-width: 100%;
        width: auto;
        margin: 0 50px 0 40px;
    }
    .progress-container-wrap .progress-container::before {
        content: "";
        background: #DCDCDC;
        position: absolute;
        top: 50%;
        left: 0;
        transform: translateY(-50%);
        height: 3px;
        width: 100%;
        z-index: 0;
    }
    .progress-container-wrap .progress {
        background: var(--drawerColor);
        position: absolute;
        top: 50%;
        left: 0;
        transform: translateY(-50%);
        height: 3px;
        width: 0%;
        /* z-index: -1; */
        transition: 0.4s ease;
    }
    .progress_offer_wrap {
        background-image: linear-gradient(-65deg, var(--drawerColor), var(--drawerColor));
        text-align: center;
        font-size: 13px;
        letter-spacing: normal;
    }
    .progress_offer_wrap p {
        margin-top: 5px !important;
          letter-spacing: normal;
        margin: 0;
    color:#fff;
        padding: 2px 2px 4px 2px;
    }

    .progress_offer_wrap p {
        margin-top: 10px;
        letter-spacing: normal;
        /* font-family: 'poppins-Medium' !important; */
    }
    .circle.alu {
        border: none;
        background: none;
        width: 0;
        height: 0;
        margin: 0;
        padding: 0;
        position: static;
    }
    .progress-container-wrap .circle {
        background: #fff;
        color: #999;
        border-radius: 50%;
        height: 30px;
        width: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid #64112f !important;
        transition: .4s ease;
        position: relative;
    }

    .progress-container-wrap .circle.active {
        border-color: var(--drawerColor);
        background:  var(--drawerColor);
        color: #fff;
        /* box-shadow: 0px 0px 12px #FF40B1; */
    }
    .progress-container-wrap .circle {
        background: #fff;
        color: #999;
        border-radius: 50%;
        height: 30px;
        width: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid #ff40b1;
        transition: .4s ease;
        position: relative;
    }
    .progress-container-wrap .circle img {
        border-radius: 50%;
          filter: saturate(0.5) saturate(0.5) grayscale(0);
    }
    .progress-container-wrap .circle span {
        margin-top: 95px;
        width: 117px !important;
        position: absolute;
        line-height: 1;
    }
    .progress-container-wrap p {
        color: #000;
        font-size: 9px;
          padding: 0 4px !important;
    }
    .progress-container-wrap .circle.active::after {
        content: '';
        background-image: url('https://cdn.shopify.com/s/files/1/0361/8553/8692/files/active-right-sign.png?v=1732347738');
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        position: absolute;
        top: -39%;
        left: 10px;
        height: 20px;
        width: 20px;
        z-index: 0;
        display: block;
    }

    div#progress {
        display: block;
    }
    .progress-container{height:100% !important; overflow: unset !important; background:transparent !important;}
    .progress-note p {
        padding: 8px 14px;
        text-align: center;
        margin: 0;
        font-size: 14px;
        font-family: 'GOTHAM-2';
        color: #64112f;
        letter-spacing: 0;
    }
    /* ==================== End: Progress Bar =============== */
</style>

<div class="progress-wrapper">
  <div class="progress-note"><p>Free Gift Available at Checkout</p></div>
  <div class="progress_offer_wrap">
    <p>Spend ₹1299 or more – Get a Reusable Face Sponge (Free)</p>
  </div>
  <div class="progress-container-bg-color">
    <div class="progress-container-wrap">
      <div class="progress-container">
        <div
          class="progress"
          id="progress"
          style="width: 33%;"
        ></div>
        <div class="circle active">
          <img
            src="https://cdn.shopify.com/s/files/1/0361/8553/8692/files/gift_1.gif?v=1732354527"
            style="width: 26px; height: auto;"
            loading="lazy" width="" height=""
          >
          <span><p>{{ block.settings.cp-text1}}</p></span>
        </div>
        <div class="circle ">
          <img
            src="https://cdn.shopify.com/s/files/1/0361/8553/8692/files/gift_1.gif?v=1732354527"
            style="width: 26px; height: auto;"
            loading="lazy" width="" height=""
          >
          <span><p>{{ block.settings.cp-text2 }}</p></span>
        </div>
        <div class="circle ">
          <img
            src="https://cdn.shopify.com/s/files/1/0361/8553/8692/files/gift_1.gif?v=1732354527"
            style="box-shadow: 0px 0px 12px #FF40B1; width: 26px; height: auto;"
            loading="lazy" width="" height=""
          >
          <span><p>{{ block.settings.cp-text3}}</p></span>
        </div>

      </div>
    </div>
  </div>
</div>

<script>
  const priceRange1 = parseFloat("{{ block.settings.cp-price-1 }}");
  const priceRange2 = parseFloat("{{ block.settings.cp-price-2 }}");
  const priceRange3 = parseFloat("{{ block.settings.cp-price-3 }}");

  const priceText1 = "{{ block.settings.cp-text1 }}";
  const priceText2 = "{{ block.settings.cp-text2 }}";
  const priceText3 = "{{ block.settings.cp-text3 }}";

  const PROGRESS_STORAGE_KEY = "progressHTML";

  function storeProgressHTML() {
    const progressWrapper = document.querySelector(".progress-wrapper");
    if (progressWrapper && !localStorage.getItem(PROGRESS_STORAGE_KEY)) {
      localStorage.setItem(PROGRESS_STORAGE_KEY, progressWrapper.outerHTML);
    }
  }

  function appendProgressBarToDrawer() {
    const drawerHeader = document.querySelector(".drawer__header");
    const storedHTML = localStorage.getItem(PROGRESS_STORAGE_KEY);
    const alreadyInserted = document.querySelector(".drawer__header + .progress-wrapper");

    if (drawerHeader && storedHTML && !alreadyInserted) {
      drawerHeader.insertAdjacentHTML("afterend", storedHTML);
    }
  }

  function updateProgressBar(cartTotal) {
    const note = document.querySelector('.progress-note');
    const offerWrap = document.querySelector('.progress_offer_wrap');
    const containerBG = document.querySelector('.progress-container-bg-color');
    const progressBar = document.getElementById('progress');
    const circles = document.querySelectorAll('.circle');
    const offerTextElement = document.querySelector('.progress_offer_wrap p');



 

    let width = '0%';
    let text = '';

    circles.forEach(c => c.classList.remove('active'));

    if (cartTotal >= priceRange1 && cartTotal < priceRange2) {
      width = '25%';
      text = priceText1;
      circles[0]?.classList.add('active');
    } else if (cartTotal >= priceRange2 && cartTotal < priceRange3) {
      width = '50%';
      text = priceText2;
      circles[0]?.classList.add('active');
      circles[1]?.classList.add('active');
    } else if (cartTotal >= priceRange3) {
      width = '100%';
      text = priceText3;
      circles.forEach(c => c.classList.add('active'));
    }

    if (progressBar) progressBar.style.width = width;
    if (offerTextElement) offerTextElement.textContent = text;

    appendProgressBarToDrawer(); // Insert if needed
  }

  function getCartDataAndUpdate() {
    fetch('/cart.js')
      .then(res => res.ok ? res.json() : Promise.reject("Fetch error"))
      .then(data => updateProgressBar(data.total_price / 100))
      .catch(console.error);
  }

  document.addEventListener('DOMContentLoaded', () => {
    storeProgressHTML();        // Store initial HTML
    getCartDataAndUpdate();     // Initial load
    setInterval(getCartDataAndUpdate, 3000); // Polling every 3s
  });
</script>


{% schema %}
{
  "name": "Cart Progress bar",
  "target":"section",
  "settings": [
    {
      "type":"text",
      "id": "cart-heading",
      "label":"Progressbar Heading",
      "info":"Free Gift Available at Checkout",
    },
    {
      "type":"text",
      "id": "cp-text1",
      "label":"Price Range Text-1",
      "info":"e.g: Spend ₹1000 – Get a 10% discount on an order",
    },
    {
      "type":"text",
      "id": "cp-text2",
      "label":"Price Range Text-2",
      "info":"e.g: Spend ₹1000 – Get a 15% discount on an order",
    },
    {
      "type":"text",
      "id": "cp-text3",
      "label":"Price Range Text-3",
      "info":"e.g: Spend ₹1000 – Get a 20% discount on an order",
    },
    {
      "type":"text",
      "id":"cp-price-1",
      "label":"Price Range Amount -1",
      "info": "e.g: $1000"
    },
      {
      "type":"text",
      "id":"cp-price-2",
      "label":"Price Range Amount -2",
      "info": "e.g: $2000"
    },
    {
      "type":"text",
      "id":"cp-price-3",
      "label":"Price Range Amount -3",
      "info": "e.g: $3000"
    }
  ]
}
{% endschema %}

{% if template.name == 'product' %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<style>
  :root {
    --drawerColor: #64112f;
    --fontSizeDesktop: {{ block.settings.font_size_desktop | default: '14px' }};
    --fontSizeMobile: {{ block.settings.font_size_mobile | default: '12px' }};
    --textColor: {{ block.settings.text_color | default: '#ffffff' }};
    --bgColor: {{ block.settings.bg_color | default: '#64112f' }};
  }

  .progress-wrapper {
    margin-bottom: 2rem;
    border: 1px solid #eee;
    padding: 10px;
    border-radius: 6px;
  }

  .progress-container-bg-color {
    background: #fff;
    height: 95px;
    padding: 3px 0;
  }

  .progress-container-wrap {
    margin-top: 10px;
    text-align: center;
    margin-bottom: 60px;
  }

  .progress-container {
    display: flex;
    justify-content: space-between;
    position: relative;
    margin: 0 50px;
  }

  .progress-container::before {
    content: "";
    background: #DCDCDC;
    position: absolute;
    top: 50%;
    left: 0;
    transform: translateY(-50%);
    height: 3px;
    width: 100%;
    z-index: 0;
  }

  .progress {
    background: var(--drawerColor);
    position: absolute;
    top: 50%;
    left: 0;
    transform: translateY(-50%);
    height: 3px;
    width: 0%;
    transition: 0.4s ease;
  }

  .progress_offer_wrap {
    background: var(--bgColor);
    text-align: center;
    font-size: var(--fontSizeDesktop);
  }

  .progress_offer_wrap p {
    margin: 5px 0;
    color: var(--textColor);
    padding: 2px 2px 4px 2px;
  }

  .circle {
    background: #fff;
    color: #999;
    border-radius: 50%;
    height: 30px;
    width: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid var(--drawerColor);
    position: relative;
    transition: 0.4s ease;
  }

  .circle.active {
    background: var(--drawerColor);
    color: #fff;
  }

  .circle img {
    border-radius: 50%;
    filter: saturate(0.5);
  }

  .circle span {
    position: absolute;
    top: 100%;
    margin-top: 10px;
    width: 100px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 10px;
    color: #000;
  }

  .circle.active::after {
    content: '';
    background: url('https://cdn.shopify.com/s/files/1/0361/8553/8692/files/active-right-sign.png?v=1732347738') no-repeat center/contain;
    position: absolute;
    top: -30%;
    left: 10px;
    height: 20px;
    width: 20px;
  }

  .progress-note p {
    padding: 8px 14px;
    text-align: center;
    margin: 0;
    font-size: 14px;
    color: var(--drawerColor);
  }

  @media(max-width:767px){
    .progress-container {
      margin: 0 21px !important;
    }
    .circle span {
      width: 90px;
      font-size: 10px;
    }
    .progress-wrapper {
      padding: 0;
    }
    .progress_offer_wrap {
      font-size: var(--fontSizeMobile);
    }
  }
</style>

<!-- ðŸ”” Store Owner Message (visible in editor only) -->
{% if content_for_header contains 'shopify.designMode' %}
  <div style="background: #fff6d8; padding: 10px; border: 1px dashed #ffb52c; margin-bottom: 20px; font-size: 13px;">
    ðŸ”§ <strong>Note for Store Owner:</strong><br>
    Please manually create discount codes that match the milestone offers you've mentioned above (like FREEGIFT1000, GIFT2000, etc.). This bar only shows the messaging and does not apply discounts automatically.
  </div>
{% endif %}

<div class="progress-wrapper">
  <div class="progress-note"><p>{{ block.settings.cart-heading }}</p></div>
  <div class="progress_offer_wrap">
    <p>{{ block.settings.cp-text1 }}</p>
  </div>
  <div class="progress-container-bg-color">
    <div class="progress-container-wrap">
      <div class="progress-container">
        <div class="progress" id="progress"></div>

        <div class="circle">
          <img src="https://cdn.shopify.com/s/files/1/0361/8553/8692/files/gift_1.gif?v=1732354527" style="width: 26px;" loading="lazy">
          <span>{{ block.settings.cp-text1 }}</span>
        </div>
        <div class="circle">
          <img src="https://cdn.shopify.com/s/files/1/0361/8553/8692/files/gift_1.gif?v=1732354527" style="width: 26px;" loading="lazy">
          <span>{{ block.settings.cp-text2 }}</span>
        </div>
        <div class="circle">
          <img src="https://cdn.shopify.com/s/files/1/0361/8553/8692/files/gift_1.gif?v=1732354527" style="width: 26px;" loading="lazy">
          <span>{{ block.settings.cp-text3 }}</span>
        </div>

      </div>
    </div>
  </div>
</div>

<script>
  const priceRanges = [
    parseFloat("{{ block.settings.cp-price-1 }}") || 0,
    parseFloat("{{ block.settings.cp-price-2 }}") || 0,
    parseFloat("{{ block.settings.cp-price-3 }}") || 0
  ].sort((a, b) => a - b);

  const priceTexts = [
    `{{ block.settings.cp-text1 | escape }}`,
    `{{ block.settings.cp-text2 | escape }}`,
    `{{ block.settings.cp-text3 | escape }}`
  ];

  function updateProgressBar(cartTotal) {
    const progressBar = document.getElementById('progress');
    const circles = document.querySelectorAll('.circle');
    const offerTextElement = document.querySelector('.progress_offer_wrap p');

    let width = '0%';
    let activeCount = 0;

    if (cartTotal >= priceRanges[2]) {
      width = '100%';
      activeCount = 3;
    } else if (cartTotal >= priceRanges[1]) {
      width = '66%';
      activeCount = 2;
    } else if (cartTotal >= priceRanges[0]) {
      width = '33%';
      activeCount = 1;
    }

    progressBar.style.width = width;
    offerTextElement.textContent = priceTexts[activeCount - 1] || priceTexts[0];

    circles.forEach((circle, index) => {
      circle.classList.toggle('active', index < activeCount);
    });
  }

  function getCartDataAndUpdate() {
    fetch('/cart.js')
      .then(res => res.ok ? res.json() : Promise.reject("Fetch error"))
      .then(data => updateProgressBar(data.total_price / 100))
      .catch(console.error);
  }

  document.addEventListener('DOMContentLoaded', () => {
    getCartDataAndUpdate();
    setInterval(getCartDataAndUpdate, 3000);
  });
</script>
{% endif %}

{% schema %}
{
  "name": "Cart Progress Bar",
  "target": "section",
  "settings": [
    {
      "type": "text",
      "id": "cart-heading",
      "label": "Progress Bar Heading",
      "default": "Free Gift Available at Checkout"
    },
    {
      "type": "text",
      "id": "cp-text1",
      "label": "Milestone 1 Text",
      "default": "Spend â‚¹1000 â€“ Get a FREE gift"
    },
    {
      "type": "text",
      "id": "cp-text2",
      "label": "Milestone 2 Text",
      "default": "Spend â‚¹2000 â€“ Get 2 FREE gifts"
    },
    {
      "type": "text",
      "id": "cp-text3",
      "label": "Milestone 3 Text",
      "default": "Spend â‚¹3000 â€“ Get a Premium Gift"
    },
    {
      "type": "text",
      "id": "cp-price-1",
      "label": "Price Range 1 (â‚¹)",
      "default": "1000"
    },
    {
      "type": "text",
      "id": "cp-price-2",
      "label": "Price Range 2 (â‚¹)",
      "default": "2000"
    },
    {
      "type": "text",
      "id": "cp-price-3",
      "label": "Price Range 3 (â‚¹)",
      "default": "3000"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Progress Bar Background Color",
      "default": "#64112f"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Progress Text Color",
      "default": "#ffffff"
    },
    {
      "type": "text",
      "id": "font_size_desktop",
      "label": "Font Size (Desktop)",
      "default": "14px"
    },
    {
      "type": "text",
      "id": "font_size_mobile",
      "label": "Font Size (Mobile)",
      "default": "12px"
    }
  ]
}
{% endschema %}
